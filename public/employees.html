<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paysense: Manage Employees</title>

    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <script src="/js/main.js"></script>

    <script defer src="/__/firebase/7.16.1/firebase-app.js"></script>
    <script defer src="/__/firebase/7.16.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.16.1/firebase-firestore.js"></script>
    <script defer src="/__/firebase/init.js"></script>
</head>

<body>
    <h1>Manage Employees</h1>
    <nav>
        <ul>
            <a href="/dashboard.html">
                <li>Dashboard</li>
            </a>
            <a href="https://calendar.google.com/calendar/" target="_blank">
                <li>Calendar</li>
            </a>
            <a href="/employees.html">
                <li>Manage Employees</li>
            </a>
            <a href="/payroll.html">
                <li>Run Payroll</li>
            </a>
            <li>Past Payrolls</li>
        </ul>
    </nav>

    <main>
        <h2>Employees</h2>

        <form id="addEmployeeForm" action="javascript:addEmployee()">
            <label for="name">Name:</label><br>
            <input type="text" name="name" id="name" required><br>

            <label for="email">Email:</label><br>
            <input type="email" name="email" id="email"><br>

            <label for="hourlyWage">Hourly Wage:</label><br>
            <input type="number" name="hourlyWage" id="hourlyWage" min="0" step="0.01" required><br>

            <label for="w4filingStatus">W4 Filing Status:</label><br>
            <select id="w4filingStatus" name="w4filingStatus" required><br>
                <option value="single">Single</option>
                <option value="marriedFilingSeparately">Married Filing Separately</option>
                <option value="marriedFilingJointly">Married Filing Jointly</option>
                <option value="headOfHousehold">Head of Household</option>
            </select><br>

            <label for="w4twoJobs">W4 Step 2c checkbox:</label><br>
            <input type="radio" id="w4twoJobsYes" name="w4twoJobs" value="yes" required>
            <label for="w4twoJobsYes">Yes</label><br>
            <input type="radio" id="w4twoJobsNo" name="w4twoJobs" value="no" required>
            <label for="w4twoJobsNo">No</label><br>

            <label for="w4step3">W4 Step 3:</label><br>
            <input type="number" name="w4step3" id="w4step3" min="0" step="0.01" required><br>

            <label for="w4step4a">W4 Step 4a:</label><br>
            <input type="number" name="w4step4a" id="w4step4a" min="0" step="0.01" required><br>

            <label for="w4step4b">W4 Step 4b:</label><br>
            <input type="number" name="w4step4b" id="w4step4b" min="0" step="0.01" required><br>

            <label for="w4step4c">W4 Step 4c:</label><br>
            <input type="number" name="w4step4c" id="w4step4c" min="0" step="0.01" required><br>

            <label for="w4step4c">W4 Step 4c:</label><br>
            <input type="number" name="w4step4c" id="w4step4c" min="0" step="0.01" required><br>

            <label for="stateTaxExempt">Exempt From State Tax: </label>
            <input type="checkbox" name="stateTaxExempt" id="stateTaxExempt" onclick="toggleStateTax()"><br>

            <div id="stateTaxInfo">
                <p>Take a look at the G4 form for this information which can be found <a href="https://dor.georgia.gov/sites/dor.georgia.gov/files/related_files/document/TSD/Form/TSD_Employees_Withholding_Allowance_Certificate_G-4.pdf" target="_blank">here</a>.</p>

                <label for="stateFilingStatus">State Filing Status (line 3):</label><br>
                <select id="stateFilingStatus" name="stateFilingStatus" required><br>
                    <option value="single">Single</option>
                    <option value="marriedFilingSeparately">Married Filing Separately</option>
                    <option value="marriedFilingJointly-bothSpousesWorking">Married Filing Jointly, both spouses working</option>
                    <option value="marriedFilingJointly-oneSpouseWorking">Married Filing Jointly, one spouse working</option>
                    <option value="headOfHousehold">Head of Household</option>
                </select><br>

                <label for="statePersonalAllowances">Personal Allowances (line 3):</label><br>
                <select id="statePersonalAllowances" name="statePersonalAllowances" required><br>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                </select><br>

                <label for="stateDependentAllowance">Dependent Allowance (line 4):</label><br>
                <input type="number" name="stateDependentAllowance" id="stateDependentAllowance" required><br>

                <label for="stateAdditionalWitholding">Additional Witholding (line 6):</label><br>
                <input type="number" name="stateAdditionalWitholding" id="stateAdditionalWitholding" min="0" step="0.01" required><br>
            </div>

            <input type="submit" value="Add Employee">
        </form>

        <div id="employeesInformation"></div>

        <div id="editEmployee"></div>
    </main>

</body>

<script>
    let employeesCollectionRef;

    document.addEventListener('DOMContentLoaded', function () {
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                employeesCollectionRef = firebase.firestore()
                    .collection('test')
                    .doc(user.uid)
                    .collection('employees');

                populateEmployeeInformation();
            }
            else {
                window.location.href = 'index.html';
            }
        });
    });

    function populateEmployeeInformation() {
        employeesCollectionRef.onSnapshot((querySnapshot) => {
            if (querySnapshot.size == 0) {
                document.getElementById('employeesInformation').innerHTML = '<p>You have no employees</p>';
            } else {
                let table = `<table>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Hourly Wage</th>
                                    <th>W4 Filing Status</th>
                                    <th>State Tax Exempt</th>
                                </tr>`;
                querySnapshot.forEach(employeeDocRef => {
                    const employee = employeeDocRef.data();
                    table += getEmployeeTableRow(employeeDocRef.id, employee.name, employee.email, employee.hourlyWage, employee.w4Data.filingStatus, employee.stateTaxExempt);
                });
                table += '</table>';
                document.getElementById('employeesInformation').innerHTML = table;
            }
        });
    }

    function addEmployee() {
        var employee = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            hourlyWage: parseFloat(document.getElementById('hourlyWage').value),
            w4Data: {
                filingStatus: document.getElementById('w4filingStatus').value,
                twoJobs: document.getElementById('w4twoJobsYes').checked,
                step3: parseFloat(document.getElementById('w4step3').value),
                step4a: parseFloat(document.getElementById('w4step4a').value),
                step4b: parseFloat(document.getElementById('w4step4b').value),
                step4c: parseFloat(document.getElementById('w4step4c').value)
            },
            stateTaxExempt: document.getElementById("stateTaxExempt").checked
        };
        if (!employee.stateTaxExempt) {
            employee.stateTaxInfo = {
                filingStatus: document.getElementById('stateFilingStatus').value,
                personalAllowances: parseFloat(document.getElementById('statePersonalAllowances').value),
                dependentAllowance: parseFloat(document.getElementById('stateDependentAllowance').value),
                additionalWitholding: parseFloat(document.getElementById('stateAdditionalWitholding').value)
            };
        }
        employeesCollectionRef.add(employee);
        document.getElementById('addEmployeeForm').reset();
    }

    function getEmployeeTableRow(employeeDocRefId, name, email, hourlyWage, w4filingStatus, stateTaxExempt) {
        return `<tr>
                    <td><button onclick="deleteEmployee('${employeeDocRefId}')">Delete</button></td>
                    <td><button onclick="editEmployeeForm('${employeeDocRefId}')">Edit</button></td>
                    <td>${name}</td>
                    <td>${email}</td>
                    <td>${hourlyWage}</td>
                    <td>${w4filingStatus}</td>
                    <td>${stateTaxExempt}</td>
                </tr>`;
    }

    function deleteEmployee(employeeDocRefId) {
        employeesCollectionRef.doc(employeeDocRefId).delete();
    }

    function editEmployeeForm(employeeDocRefId) {
        console.log("Edit")
        let editForm = ` <form id="updateEmployeeForm" action="javascript:editEmployeeSubmit('${employeeDocRefId}')">
                            <label for="name">Name:</label><br>
                            <input type="text" name="name" id="editName" required><br>
                            <input type="submit" value="Add Employee">
                        </form>`;
        document.getElementById("editEmployee").innerHTML = editForm;
        // employeesCollectionRef.doc(employeeDocRefId).update({name: document.getElementById("updateEmployee").name.value()})
    }

    function editEmployeeSubmit(employeeDocRefId) {
        console.log("hi")
        newName = document.getElementById("editName").value;
        employeesCollectionRef.doc(employeeDocRefId).update({name: newName});
        document.getElementById("editEmployee").innerHTML=``;
    }

    function toggleStateTax() {
        document.getElementById("stateTaxInfo").style.display = document.getElementById("stateTaxExempt").checked ? "none" : "block";
    }
</script>

</html>